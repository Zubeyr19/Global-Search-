@startuml Global Search System - Package Diagram (Actual Implementation)
!theme plain

skinparam packageStyle rectangle

' Main Application
package "com.globalsearch" <<Rectangle>> {

    ' Controllers Layer
    package "controller" <<Rectangle>> #LightBlue {
        package "controller.auth" {
            component [AuthController] as AuthCtrl
        }
        package "controller.search" {
            component [GlobalSearchController] as SearchCtrl
        }
        package "controller.admin" {
            component [AdminController] as AdminCtrl
        }
        component [UserController] as UserCtrl
        component [AuditLogController] as AuditCtrl
        component [PolicyController] as PolicyCtrl
        component [PerformanceController] as PerfCtrl
        component [ElasticsearchSyncController] as SyncCtrl
        component [WebSocketController] as WSCtrl

        note right of SearchCtrl
            Handles:
            - Global search (tenant-scoped)
            - Quick search
            - Search by entity type
            - Admin cross-tenant search
            - Search statistics
        end note
    }

    ' Service Layer
    package "service" <<Rectangle>> #LightGreen {
        package "service.auth" {
            component [CustomUserDetailsService] as UserDetailsService
        }
        package "service.search" {
            component [SearchService] as SearchSvc
            component [AdvancedSearchService] as AdvSearchSvc
        }
        component [UserService] as UserSvc
        component [AdminService] as AdminSvc
        component [AuditLogService] as AuditSvc
        component [PolicyService] as PolicySvc
        component [DashboardService] as DashSvc
        component [ReportService] as ReportSvc
        component [ExportService] as ExportSvc
        component [NotificationService] as NotifySvc
        component [PerformanceMetricsService] as MetricsSvc
        component [LoginAttemptService] as LoginAttemptSvc
        component [ElasticsearchSyncService] as ElasticSyncSvc
        component [EntitySyncListener] as EntityListener
        component [DataInitializationService] as DataInitSvc

        note right of SearchSvc
            Core search logic:
            - Tenant-based filtering
            - Caching with @Cacheable
            - Fuzzy search
            - Synonym expansion
            - Real-time notifications
        end note
    }

    ' Repository Layer
    package "repository" <<Rectangle>> #Yellow {
        package "repository.search (Elasticsearch)" {
            interface [CompanySearchRepository] as CompanySearchRepo
            interface [LocationSearchRepository] as LocationSearchRepo
            interface [ZoneSearchRepository] as ZoneSearchRepo
            interface [SensorSearchRepository] as SensorSearchRepo
            interface [DashboardSearchRepository] as DashSearchRepo
            interface [ReportSearchRepository] as ReportSearchRepo
        }

        interface [UserRepository] as UserRepo
        interface [CompanyRepository] as CompanyRepo
        interface [LocationRepository] as LocationRepo
        interface [ZoneRepository] as ZoneRepo
        interface [SensorRepository] as SensorRepo
        interface [DashboardRepository] as DashRepo
        interface [ReportRepository] as ReportRepo
        interface [AuditLogRepository] as AuditRepo
        interface [PolicyRepository] as PolicyRepo

        note right of CompanySearchRepo
            Elasticsearch repositories
            for fast full-text search
        end note
    }

    ' Entity Layer
    package "entity (MySQL)" <<Rectangle>> #Pink {
        class User
        class Company
        class Location
        class Zone
        class Sensor
        class SensorData
        class Dashboard
        class Report
        class AuditLog
        class Policy

        note right of User
            Multi-tenant entities
            with tenantId field
        end note
    }

    ' Document Layer
    package "document (Elasticsearch)" <<Rectangle>> #Lavender {
        class CompanyDocument
        class LocationDocument
        class ZoneDocument
        class SensorDocument
        class DashboardDocument
        class ReportDocument

        note right of CompanyDocument
            Elasticsearch documents
            synced from MySQL entities
        end note
    }

    ' Security Layer
    package "security" <<Rectangle>> #Orange {
        component [JwtTokenProvider] as JwtProvider
        component [JwtAuthenticationFilter] as JwtFilter
        component [JwtAuthenticationEntryPoint] as JwtEntryPoint
        component [SecurityConfig] as SecurityConf

        note right of JwtProvider
            JWT token creation,
            validation, and claims extraction
        end note
    }

    ' Configuration Layer
    package "config" <<Rectangle>> #LightGray {
        component [AppConfig]
        component [SecurityConfig] as SecConfig
        component [CacheConfig]
        component [AsyncConfig]
        component [WebSocketConfig]
        component [WebMvcConfig]
        component [OpenAPIConfig]
    }

    ' DTOs
    package "dto" <<Rectangle>> #LightCyan {
        package "dto.request" {
            class LoginRequest
            class GlobalSearchRequest
            class CreateUserRequest
            class UpdateUserRequest
            class PolicyRequest
            class AuditLogSearchRequest
        }
        package "dto.response" {
            class LoginResponse
            class GlobalSearchResponse
            class UserResponse
            class PolicyResponse
            class AuditLogResponse
            class SystemOverviewResponse
            class TenantInfoResponse
        }
        class WebSocketMessage
    }

    ' Utilities
    package "util" <<Rectangle>> #LightYellow {
        component [SearchUtils]
        component [InputSanitizer]
    }

    ' Validation
    package "validation" <<Rectangle>> #LightSalmon {
        component [PasswordValidator]
        annotation ValidPassword
    }

    ' Interceptors
    package "interceptor" <<Rectangle>> #LightPink {
        component [RateLimitInterceptor]
    }

    ' WebSocket
    package "websocket" <<Rectangle>> #LightSteelBlue {
        component [WebSocketEventListener]
    }
}

' Dependencies - Controllers to Services
SearchCtrl --> SearchSvc
SearchCtrl --> AdvSearchSvc
AuthCtrl --> UserDetailsService
AuthCtrl --> JwtProvider
AuthCtrl --> AuditSvc
AuthCtrl --> LoginAttemptSvc
AdminCtrl --> AdminSvc
AdminCtrl --> ExportSvc
UserCtrl --> UserSvc
AuditCtrl --> AuditSvc
PolicyCtrl --> PolicySvc
PerfCtrl --> MetricsSvc
SyncCtrl --> ElasticSyncSvc
WSCtrl --> NotifySvc

' Services to Repositories
SearchSvc --> CompanySearchRepo
SearchSvc --> LocationSearchRepo
SearchSvc --> ZoneSearchRepo
SearchSvc --> SensorSearchRepo
SearchSvc --> DashSearchRepo
SearchSvc --> ReportSearchRepo
SearchSvc --> AuditSvc
SearchSvc --> MetricsSvc
SearchSvc --> NotifySvc

UserSvc --> UserRepo
AdminSvc --> UserRepo
AdminSvc --> CompanyRepo
AdminSvc --> AuditRepo
AuditSvc --> AuditRepo
PolicySvc --> PolicyRepo
ElasticSyncSvc --> CompanyRepo
ElasticSyncSvc --> LocationRepo
ElasticSyncSvc --> ZoneRepo
ElasticSyncSvc --> SensorRepo

' Repositories to Entities
UserRepo --> User
CompanyRepo --> Company
LocationRepo --> Location
ZoneRepo --> Zone
SensorRepo --> Sensor
DashRepo --> Dashboard
ReportRepo --> Report
AuditRepo --> AuditLog
PolicyRepo --> Policy

' Search Repositories to Documents
CompanySearchRepo --> CompanyDocument
LocationSearchRepo --> LocationDocument
ZoneSearchRepo --> ZoneDocument
SensorSearchRepo --> SensorDocument
DashSearchRepo --> DashboardDocument
ReportSearchRepo --> ReportDocument

' Security Dependencies
JwtFilter --> JwtProvider
JwtFilter --> UserDetailsService
AuthCtrl --> SecurityConf
SearchCtrl ..> JwtFilter : filtered by

' Entity Sync
EntityListener --> ElasticSyncSvc
Company ..> EntityListener : @EntityListeners
Location ..> EntityListener : @EntityListeners
Zone ..> EntityListener : @EntityListeners
Sensor ..> EntityListener : @EntityListeners

' Utility usage
SearchSvc --> SearchUtils
AuthCtrl --> InputSanitizer

@enduml
