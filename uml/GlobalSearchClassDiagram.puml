@startuml Global Search System - Class Diagram
!define ENTITY_COLOR #E8F5E9
!define DOCUMENT_COLOR #E3F2FD
!define REPOSITORY_COLOR #FFF3E0
!define SERVICE_COLOR #FCE4EC
!define CONTROLLER_COLOR #F3E5F5
!define SECURITY_COLOR #FFEBEE
!define DTO_COLOR #E0F2F1

skinparam class {
    BackgroundColor<<Entity>> ENTITY_COLOR
    BackgroundColor<<Document>> DOCUMENT_COLOR
    BackgroundColor<<Repository>> REPOSITORY_COLOR
    BackgroundColor<<Service>> SERVICE_COLOR
    BackgroundColor<<Controller>> CONTROLLER_COLOR
    BackgroundColor<<Security>> SECURITY_COLOR
    BackgroundColor<<DTO>> DTO_COLOR
    BorderColor Black
    ArrowColor Black
}

skinparam packageStyle rectangle
skinparam linetype ortho

package "Entity Layer (MySQL)" <<Rectangle>> {

    class User <<Entity>> {
        - id: Long
        - username: String
        - password: String
        - email: String
        - firstName: String
        - lastName: String
        - tenantId: String
        - companyId: Long
        - roles: Set<Role>
        - enabled: Boolean
        - lastLogin: LocalDateTime
        - createdAt: LocalDateTime
        - updatedAt: LocalDateTime
        --
        + getFullName(): String
        + hasRole(Role): boolean
        + isAdmin(): boolean
    }

    enum Role {
        SUPER_ADMIN
        TENANT_ADMIN
        MANAGER
        OPERATOR
        VIEWER
    }

    class Company <<Entity>> {
        - id: Long
        - name: String
        - tenantId: String
        - industry: String
        - description: String
        - contactEmail: String
        - contactPhone: String
        - address: String
        - city: String
        - state: String
        - country: String
        - postalCode: String
        - status: CompanyStatus
        - maxUsers: Integer
        - maxLocations: Integer
        - maxSensors: Integer
        - locations: List<Location>
        - users: List<User>
        - createdAt: LocalDateTime
        - updatedAt: LocalDateTime
        --
        + isActive(): boolean
        + canAddUsers(int): boolean
        + canAddLocations(int): boolean
    }

    enum CompanyStatus {
        ACTIVE
        INACTIVE
        SUSPENDED
        TRIAL
    }

    class Location <<Entity>> {
        - id: Long
        - name: String
        - type: String
        - address: String
        - city: String
        - state: String
        - country: String
        - postalCode: String
        - latitude: Double
        - longitude: Double
        - description: String
        - totalArea: Double
        - timeZone: String
        - company: Company
        - zones: List<Zone>
        - status: LocationStatus
        - managerName: String
        - managerEmail: String
        - managerPhone: String
        - createdAt: LocalDateTime
        - updatedAt: LocalDateTime
        --
        + getFullAddress(): String
        + isActive(): boolean
        + hasCoordinates(): boolean
    }

    enum LocationStatus {
        ACTIVE
        INACTIVE
        MAINTENANCE
        CLOSED
    }

    class Zone <<Entity>> {
        - id: Long
        - name: String
        - type: String
        - description: String
        - floorNumber: Integer
        - areaSize: Double
        - location: Location
        - sensors: List<Sensor>
        - status: ZoneStatus
        - temperatureMin: Double
        - temperatureMax: Double
        - humidityMin: Double
        - humidityMax: Double
        - alertEnabled: Boolean
        - createdAt: LocalDateTime
        - updatedAt: LocalDateTime
        --
        + isActive(): boolean
    }

    enum ZoneStatus {
        ACTIVE
        INACTIVE
        MAINTENANCE
        RESTRICTED
    }

    class Sensor <<Entity>> {
        - id: Long
        - name: String
        - serialNumber: String
        - sensorType: SensorType
        - manufacturer: String
        - model: String
        - description: String
        - zone: Zone
        - status: SensorStatus
        - lastReadingTime: LocalDateTime
        - lastReadingValue: Double
        - unitOfMeasurement: String
        - readingInterval: Integer
        - alertThresholdMin: Double
        - alertThresholdMax: Double
        - batteryLevel: Integer
        - installationDate: LocalDateTime
        - lastMaintenanceDate: LocalDateTime
        - createdAt: LocalDateTime
        - updatedAt: LocalDateTime
        --
        + isActive(): boolean
        + isOnline(): boolean
        + needsMaintenance(): boolean
        + hasLowBattery(): boolean
        + isReadingInRange(Double): boolean
    }

    enum SensorType {
        TEMPERATURE
        HUMIDITY
        PRESSURE
        MOTION
        LIGHT
        SMOKE
        DOOR_WINDOW
        WATER_LEAK
        VIBRATION
        POWER_METER
        AIR_QUALITY
        CUSTOM
    }

    enum SensorStatus {
        ACTIVE
        INACTIVE
        MAINTENANCE
        FAULTY
        OFFLINE
    }

    class Dashboard <<Entity>> {
        - id: Long
        - name: String
        - tenantId: String
        - ownerId: Long
        - ownerName: String
        - description: String
        - configuration: String (JSON)
        - layout: String (JSON)
        - dashboardType: DashboardType
        - isDefault: Boolean
        - isShared: Boolean
        - isFavorite: Boolean
        - refreshInterval: Integer
        - tags: String
        - accessCount: Integer
        - lastAccessedAt: LocalDateTime
        - widgets: String (JSON)
        - filters: String (JSON)
        - permissions: String (JSON)
        - createdAt: LocalDateTime
        - updatedAt: LocalDateTime
        --
        + incrementAccessCount(): void
    }

    enum DashboardType {
        OVERVIEW
        SENSORS
        ALERTS
        PERFORMANCE
        ANALYTICS
        CUSTOM
    }

    class Report <<Entity>> {
        - id: Long
        - name: String
        - tenantId: String
        - reportType: String
        - description: String
        - filePath: String
        - fileSize: Long
        - mimeType: String
        - createdBy: Long
        - tags: String
        - isPublic: Boolean
        - parameters: String (JSON)
        - executionTimeMs: Long
        - status: ReportStatus
        - scheduledAt: LocalDateTime
        - expiresAt: LocalDateTime
        - createdAt: LocalDateTime
        - updatedAt: LocalDateTime
    }

    enum ReportStatus {
        PENDING
        GENERATING
        COMPLETED
        FAILED
        EXPIRED
        ARCHIVED
    }

    class AuditLog <<Entity>> {
        - id: Long
        - userId: Long
        - username: String
        - tenantId: String
        - action: AuditAction
        - entityType: String
        - entityId: Long
        - entityName: String
        - oldValue: String (JSON)
        - newValue: String (JSON)
        - timestamp: LocalDateTime
        - ipAddress: String
        - userAgent: String
        - requestMethod: String
        - requestUrl: String
        - responseStatus: Integer
        - responseTimeMs: Long
        - errorMessage: String
        - sessionId: String
    }

    enum AuditAction {
        LOGIN
        LOGOUT
        LOGIN_FAILED
        TOKEN_REFRESH
        PASSWORD_CHANGE
        CREATE
        READ
        UPDATE
        DELETE
        BULK_UPDATE
        BULK_DELETE
        SEARCH
        EXPORT
        USER_CREATE
        USER_UPDATE
        USER_DELETE
        PERMISSION_CHANGE
        ROLE_ASSIGNMENT
        CONFIG_CHANGE
        SYSTEM_RESTART
        BACKUP_CREATED
        DATA_MIGRATION
        ACCESS_DENIED
        SUSPICIOUS_ACTIVITY
        RATE_LIMIT_EXCEEDED
    }

    class Policy <<Entity>> {
        - id: Long
        - name: String
        - description: String
        - tenantId: Long
        - role: Role
        - rules: String (JSON)
        - active: Boolean
        - createdAt: LocalDateTime
        - updatedAt: LocalDateTime
    }

    class SensorData <<Entity>> {
        - id: Long
        - sensorId: Long
        - value: Double
        - unit: String
        - timestamp: LocalDateTime
        - quality: Integer
        - metadata: String (JSON)
    }
}

' Relationships - Entity Layer
User "1" *-- "many" Role : has
Company "1" o-- "many" Location : contains
Company "1" o-- "many" User : employs
Location "1" *-- "many" Zone : contains
Zone "1" *-- "many" Sensor : contains
Sensor "1" -- "many" SensorData : generates

package "Elasticsearch Documents" <<Rectangle>> {

    class CompanyDocument <<Document>> {
        - id: String
        - name: String
        - tenantId: String
        - industry: String
        - description: String
        - city: String
        - country: String
        - status: String
        - createdAt: LocalDateTime
        --
        + fromEntity(Company): CompanyDocument
    }

    class LocationDocument <<Document>> {
        - id: String
        - name: String
        - tenantId: String
        - companyId: String
        - companyName: String
        - type: String
        - city: String
        - country: String
        - latitude: Double
        - longitude: Double
        - status: String
        - createdAt: LocalDateTime
        --
        + fromEntity(Location): LocationDocument
    }

    class ZoneDocument <<Document>> {
        - id: String
        - name: String
        - tenantId: String
        - locationId: String
        - locationName: String
        - type: String
        - description: String
        - status: String
        - createdAt: LocalDateTime
        --
        + fromEntity(Zone): ZoneDocument
    }

    class SensorDocument <<Document>> {
        - id: String
        - name: String
        - tenantId: String
        - serialNumber: String
        - sensorType: String
        - zoneId: String
        - zoneName: String
        - locationId: String
        - locationName: String
        - status: String
        - lastReadingValue: Double
        - lastReadingTime: LocalDateTime
        - createdAt: LocalDateTime
        --
        + fromEntity(Sensor): SensorDocument
    }

    class DashboardDocument <<Document>> {
        - id: String
        - name: String
        - tenantId: String
        - ownerId: String
        - ownerName: String
        - dashboardType: String
        - description: String
        - tags: List<String>
        - isShared: Boolean
        - createdAt: LocalDateTime
        --
        + fromEntity(Dashboard): DashboardDocument
    }

    class ReportDocument <<Document>> {
        - id: String
        - name: String
        - tenantId: String
        - reportType: String
        - description: String
        - createdBy: String
        - tags: List<String>
        - status: String
        - createdAt: LocalDateTime
        --
        + fromEntity(Report): ReportDocument
    }
}

package "Repository Layer (JPA)" <<Rectangle>> {

    interface UserRepository <<Repository>> {
        + findByUsername(String): Optional<User>
        + findByEmail(String): Optional<User>
        + findByTenantId(String): List<User>
        + existsByUsername(String): boolean
        + existsByEmail(String): boolean
    }

    interface CompanyRepository <<Repository>> {
        + findByTenantId(String): Optional<Company>
        + findByName(String): Optional<Company>
        + findByStatus(CompanyStatus): List<Company>
    }

    interface LocationRepository <<Repository>> {
        + findByCompanyId(Long): List<Location>
        + findByStatus(LocationStatus): List<Location>
        + findByCity(String): List<Location>
    }

    interface ZoneRepository <<Repository>> {
        + findByLocationId(Long): List<Zone>
        + findByStatus(ZoneStatus): List<Zone>
    }

    interface SensorRepository <<Repository>> {
        + findByZoneId(Long): List<Sensor>
        + findBySerialNumber(String): Optional<Sensor>
        + findBySensorType(SensorType): List<Sensor>
        + findByStatus(SensorStatus): List<Sensor>
    }

    interface DashboardRepository <<Repository>> {
        + findByTenantId(String): List<Dashboard>
        + findByOwnerId(Long): List<Dashboard>
        + findByIsShared(Boolean): List<Dashboard>
    }

    interface ReportRepository <<Repository>> {
        + findByTenantId(String): List<Report>
        + findByCreatedBy(Long): List<Report>
        + findByStatus(ReportStatus): List<Report>
    }

    interface AuditLogRepository <<Repository>> {
        + findByUserId(Long): List<AuditLog>
        + findByTenantId(String): List<AuditLog>
        + findByAction(AuditAction): List<AuditLog>
        + findByTimestampBetween(LocalDateTime, LocalDateTime): List<AuditLog>
    }
}

package "Elasticsearch Repositories" <<Rectangle>> {

    interface CompanySearchRepository <<Repository>> {
        + search(String): List<CompanyDocument>
        + findByTenantId(String): List<CompanyDocument>
    }

    interface LocationSearchRepository <<Repository>> {
        + search(String): List<LocationDocument>
        + findByTenantId(String): List<LocationDocument>
    }

    interface SensorSearchRepository <<Repository>> {
        + search(String): List<SensorDocument>
        + findByTenantId(String): List<SensorDocument>
    }

    interface DashboardSearchRepository <<Repository>> {
        + search(String): List<DashboardDocument>
        + findByTenantId(String): List<DashboardDocument>
    }

    interface ReportSearchRepository <<Repository>> {
        + search(String): List<ReportDocument>
        + findByTenantId(String): List<ReportDocument>
    }
}

package "Service Layer" <<Rectangle>> {

    class UserService <<Service>> {
        - userRepository: UserRepository
        - passwordEncoder: PasswordEncoder
        --
        + createUser(UserRequest): UserResponse
        + updateUser(Long, UserRequest): UserResponse
        + deleteUser(Long): void
        + getUserById(Long): UserResponse
        + getAllUsers(): List<UserResponse>
        + getUsersByTenantId(String): List<UserResponse>
        + changePassword(Long, String): void
    }

    class AuthService <<Service>> {
        - userRepository: UserRepository
        - jwtTokenProvider: JwtTokenProvider
        - passwordEncoder: PasswordEncoder
        - auditLogService: AuditLogService
        --
        + login(LoginRequest): AuthResponse
        + register(RegisterRequest): AuthResponse
        + refreshToken(String): AuthResponse
        + logout(String): void
    }

    class SearchService <<Service>> {
        - companySearchRepository: CompanySearchRepository
        - locationSearchRepository: LocationSearchRepository
        - sensorSearchRepository: SensorSearchRepository
        - dashboardSearchRepository: DashboardSearchRepository
        - reportSearchRepository: ReportSearchRepository
        - auditLogService: AuditLogService
        --
        + globalSearch(SearchRequest): SearchResponse
        + searchCompanies(String, String): List<CompanyDocument>
        + searchLocations(String, String): List<LocationDocument>
        + searchSensors(String, String): List<SensorDocument>
        + quickSearch(String, String): List<SearchResult>
    }

    class AdvancedSearchService <<Service>> {
        - searchService: SearchService
        --
        + advancedSearch(AdvancedSearchRequest): SearchResponse
        + searchWithFilters(SearchRequest, Map): SearchResponse
        + fuzzySearch(String, String): SearchResponse
        + autocomplete(String, String): List<String>
    }

    class AdminService <<Service>> {
        - userRepository: UserRepository
        - companyRepository: CompanyRepository
        - auditLogRepository: AuditLogRepository
        --
        + getAllCompanies(): List<CompanyResponse>
        + getTenantStatistics(String): TenantStats
        + getSystemOverview(): SystemOverview
        + crossTenantSearch(SearchRequest): SearchResponse
    }

    class AuditLogService <<Service>> {
        - auditLogRepository: AuditLogRepository
        --
        + log(AuditLogRequest): void
        + logSearch(User, SearchRequest): void
        + logAccess(User, String, String): void
        + getAuditLogs(String): List<AuditLog>
        + getUserActivity(Long): List<AuditLog>
    }

    class DashboardService <<Service>> {
        - dashboardRepository: DashboardRepository
        - dashboardSearchRepository: DashboardSearchRepository
        --
        + createDashboard(DashboardRequest): DashboardResponse
        + updateDashboard(Long, DashboardRequest): DashboardResponse
        + deleteDashboard(Long): void
        + getDashboardById(Long): DashboardResponse
        + getUserDashboards(Long): List<DashboardResponse>
    }

    class ReportService <<Service>> {
        - reportRepository: ReportRepository
        - reportSearchRepository: ReportSearchRepository
        --
        + createReport(ReportRequest): ReportResponse
        + generateReport(Long): Report
        + getReportById(Long): ReportResponse
        + deleteReport(Long): void
    }

    class ExportService <<Service>> {
        --
        + exportToCsv(List): byte[]
        + exportToPdf(List): byte[]
        + exportToExcel(List): byte[]
    }

    class NotificationService <<Service>> {
        - messagingTemplate: SimpMessagingTemplate
        --
        + sendNotification(String, Notification): void
        + sendToUser(Long, Notification): void
        + sendToTenant(String, Notification): void
    }

    class DataInitializationService <<Service>> {
        --
        + initializeData(): void
        + createDefaultUsers(): void
        + createSampleData(): void
    }
}

package "Controller Layer (REST)" <<Rectangle>> {

    class AuthController <<Controller>> {
        - authService: AuthService
        --
        + login(LoginRequest): ResponseEntity<AuthResponse>
        + register(RegisterRequest): ResponseEntity<AuthResponse>
        + refreshToken(String): ResponseEntity<AuthResponse>
        + logout(): ResponseEntity<Void>
    }

    class GlobalSearchController <<Controller>> {
        - searchService: SearchService
        - advancedSearchService: AdvancedSearchService
        --
        + globalSearch(SearchRequest): ResponseEntity<SearchResponse>
        + quickSearch(String): ResponseEntity<List<SearchResult>>
        + advancedSearch(AdvancedSearchRequest): ResponseEntity<SearchResponse>
        + autocomplete(String): ResponseEntity<List<String>>
    }

    class AdminController <<Controller>> {
        - adminService: AdminService
        - exportService: ExportService
        --
        + getAllCompanies(): ResponseEntity<List<CompanyResponse>>
        + getTenantStats(String): ResponseEntity<TenantStats>
        + getSystemOverview(): ResponseEntity<SystemOverview>
        + crossTenantSearch(SearchRequest): ResponseEntity<SearchResponse>
        + exportUsers(String): ResponseEntity<byte[]>
    }

    class UserController <<Controller>> {
        - userService: UserService
        --
        + createUser(UserRequest): ResponseEntity<UserResponse>
        + updateUser(Long, UserRequest): ResponseEntity<UserResponse>
        + deleteUser(Long): ResponseEntity<Void>
        + getUserById(Long): ResponseEntity<UserResponse>
        + getAllUsers(): ResponseEntity<List<UserResponse>>
    }

    class DashboardController <<Controller>> {
        - dashboardService: DashboardService
        --
        + createDashboard(DashboardRequest): ResponseEntity<DashboardResponse>
        + updateDashboard(Long, DashboardRequest): ResponseEntity<DashboardResponse>
        + deleteDashboard(Long): ResponseEntity<Void>
        + getDashboardById(Long): ResponseEntity<DashboardResponse>
        + getUserDashboards(): ResponseEntity<List<DashboardResponse>>
    }

    class ReportController <<Controller>> {
        - reportService: ReportService
        --
        + createReport(ReportRequest): ResponseEntity<ReportResponse>
        + generateReport(Long): ResponseEntity<Report>
        + getReportById(Long): ResponseEntity<ReportResponse>
        + deleteReport(Long): ResponseEntity<Void>
    }

    class AuditLogController <<Controller>> {
        - auditLogService: AuditLogService
        --
        + getAuditLogs(String): ResponseEntity<List<AuditLog>>
        + getUserActivity(Long): ResponseEntity<List<AuditLog>>
        + searchAuditLogs(AuditSearchRequest): ResponseEntity<List<AuditLog>>
    }

    class WebSocketController <<Controller>> {
        - notificationService: NotificationService
        --
        + sendNotification(Notification): void
    }
}

package "Security & Configuration" <<Rectangle>> {

    class JwtTokenProvider <<Security>> {
        - secretKey: String
        - validityInMilliseconds: Long
        --
        + createToken(String, Set<Role>): String
        + getUsername(String): String
        + validateToken(String): boolean
        + resolveToken(HttpServletRequest): String
        + getAuthentication(String): Authentication
    }

    class JwtAuthenticationFilter <<Security>> {
        - jwtTokenProvider: JwtTokenProvider
        --
        + doFilterInternal(HttpServletRequest, HttpServletResponse, FilterChain): void
    }

    class SecurityConfig <<Security>> {
        - jwtTokenProvider: JwtTokenProvider
        --
        + securityFilterChain(HttpSecurity): SecurityFilterChain
        + passwordEncoder(): PasswordEncoder
        + authenticationManager(): AuthenticationManager
    }

    class TenantInterceptor <<Security>> {
        --
        + preHandle(HttpServletRequest, HttpServletResponse, Object): boolean
        + extractTenantId(HttpServletRequest): String
    }

    class RateLimitInterceptor <<Security>> {
        - rateLimiter: RateLimiter
        --
        + preHandle(HttpServletRequest, HttpServletResponse, Object): boolean
    }
}

package "DTOs" <<Rectangle>> {

    class LoginRequest <<DTO>> {
        + username: String
        + password: String
    }

    class AuthResponse <<DTO>> {
        + token: String
        + refreshToken: String
        + user: UserResponse
    }

    class SearchRequest <<DTO>> {
        + query: String
        + entityTypes: List<String>
        + filters: Map<String, Object>
        + page: int
        + size: int
        + enableFuzzySearch: boolean
        + enableHighlighting: boolean
    }

    class SearchResponse <<DTO>> {
        + results: List<SearchResult>
        + totalHits: long
        + page: int
        + totalPages: int
        + executionTimeMs: long
    }

    class SearchResult <<DTO>> {
        + id: String
        + entityType: String
        + name: String
        + description: String
        + highlights: Map<String, List<String>>
        + score: double
    }

    class UserRequest <<DTO>> {
        + username: String
        + email: String
        + firstName: String
        + lastName: String
        + roles: Set<Role>
    }

    class UserResponse <<DTO>> {
        + id: Long
        + username: String
        + email: String
        + fullName: String
        + tenantId: String
        + roles: Set<Role>
        + enabled: Boolean
    }
}

' Service Dependencies
UserRepository -- UserService : uses
UserService -- AuthService : uses
AuthService -- JwtTokenProvider : uses
AuthService -- AuditLogService : uses

SearchService -- CompanySearchRepository : uses
SearchService -- LocationSearchRepository : uses
SearchService -- SensorSearchRepository : uses
SearchService -- AuditLogService : uses

AdvancedSearchService -- SearchService : uses

AdminService -- UserRepository : uses
AdminService -- CompanyRepository : uses
AdminService -- AuditLogRepository : uses

DashboardService -- DashboardRepository : uses
DashboardService -- DashboardSearchRepository : uses

ReportService -- ReportRepository : uses
ReportService -- ReportSearchRepository : uses

' Controller Dependencies
AuthController -- AuthService : uses
GlobalSearchController -- SearchService : uses
GlobalSearchController -- AdvancedSearchService : uses
AdminController -- AdminService : uses
AdminController -- ExportService : uses
UserController -- UserService : uses
DashboardController -- DashboardService : uses
ReportController -- ReportService : uses
AuditLogController -- AuditLogService : uses
WebSocketController -- NotificationService : uses

' Security Dependencies
JwtAuthenticationFilter -- JwtTokenProvider : uses
SecurityConfig -- JwtTokenProvider : configures

' Repository Dependencies
UserRepository -- User : manages
CompanyRepository -- Company : manages
LocationRepository -- Location : manages
ZoneRepository -- Zone : manages
SensorRepository -- Sensor : manages
DashboardRepository -- Dashboard : manages
ReportRepository -- Report : manages
AuditLogRepository -- AuditLog : manages

CompanySearchRepository -- CompanyDocument : indexes
LocationSearchRepository -- LocationDocument : indexes
SensorSearchRepository -- SensorDocument : indexes
DashboardSearchRepository -- DashboardDocument : indexes
ReportSearchRepository -- ReportDocument : indexes

note right of SearchService
  Core search service that handles
  global search across all entities
  with tenant isolation and RBAC
end note

note right of JwtTokenProvider
  Handles JWT token creation,
  validation, and extraction
  of authentication details
end note

note bottom of Company
  Multi-tenant isolation
  via tenantId field
end note

note bottom of AuditLog
  Comprehensive audit logging
  for GDPR compliance and
  security monitoring
end note

@enduml
